<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pagamento - ClimaCocal</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/style.css' %}"> 
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- HLS.js para streaming -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body oncontextmenu="return false">
  <!-- HEADER MELHORADO (baseado no index) -->
  <header class="site-header">
    <div class="header-container">
      <!-- Logo -->
      <img src="{% static 'img/logo_branca_header.png' %}" alt="Logo ClimaCocal" class="logo" />

      <!-- Menu + Frase no canto superior direito -->
      <div class="menu-area">
        <button id="menuToggle" class="menu-toggle" aria-label="Menu">
          <i class="fas fa-bars"></i> <span class="menu-label">Menu</span>
        </button>

        <nav class="menu-dropdown" id="menuDropdown">
          <ul>
            <li><a href="/">In√≠cio</a></li>
            <li><a href="/#previsao">Previs√£o</a></li>
            <li><a href="/#outros-sites">Outros Sites</a></li>
          </ul>
        </nav>
      </div>

      <div class="phrase-area">
        <h1 class="header-phrase">Como </h1>
        <h1 class="header-phrase">t√° o </h1> 
        <h1 class="header-phrase">tempo?</h1>
      </div>

      <!-- Status do streaming centralizado -->
      <div class="header-center">
        <div class="streaming-status-header">
          <i class="fas fa-video text-success me-2"></i>
          <span class="text-success"><strong>Transmiss√£o Ativa</strong></span>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO SECTION MELHORADA (baseada no index) -->
  <section class="hero">
    <div class="hero-content">
      <div class="hero-text">
        {% if test_mode %}
        <div class="alert alert-warning mb-3" style="background: rgba(255, 243, 205, 0.9); border-radius: 12px;">
          <i class="fas fa-flask me-2"></i><strong>MODO TESTE</strong> - {{ message }}
        </div>
        {% endif %}
        
        <h1><i class="fas fa-check-circle text-success"></i><br>Pagamento<br>Aprovado!</h1>
        
        <p class="hero-description">
          Acesso liberado para transmiss√£o ao vivo de <strong>Cocalzinho de Goi√°s</strong>
        </p>
        
        <button id="watchStreamBtn" class="btn-primary hero-btn">
          <i class="fas fa-play-circle me-2"></i> Assistir ao Vivo
        </button>
        
        <div class="baloes mt-4">
          <p class="balao">üìπ Transmiss√£o em tempo real</p>
          <p class="balao">‚è±Ô∏è Acesso por 3 minutos</p>
          <p class="balao">üå§Ô∏è Clima atual de Cocalzinho</p>
        </div>
        
        <div class="mt-4">
          <a href="/" class="btn btn-outline-light">
            <i class="fas fa-home me-1"></i> P√°gina Inicial
          </a>
        </div>
      </div>
      
      <div class="hero-image">
        <div class="img-bg">
          <img src="{% static 'img/maocelular.png' %}" alt="Transmiss√£o ao vivo" />
        </div>
      </div>
    </div>
  </section>

<!-- SE√á√ÉO ESCALADORES -->
<section class="climber-info-section" style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); padding: 3rem 0;">
  <div class="container" style="max-width: 800px; margin: 0 auto; text-align: center;">
    <h2 style="color: #2c5530; margin-bottom: 2rem;">
      <i class="fas fa-mountain"></i> Para Escaladores
    </h2>
    
    <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
      <h3 style="color: #4a7c59; margin-bottom: 1.5rem;">
        üéâ Cadastro Gratuito Dispon√≠vel!
      </h3>
      
      <p style="font-size: 1.1rem; color: #555; margin-bottom: 1.5rem;">
        Escaladores t√™m acesso <strong>gratuito</strong> √† transmiss√£o at√© <strong>11 de Novembro</strong>!<br>
        Perfeito para planejar suas escaladas com informa√ß√µes em tempo real.
      </p>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
          <i class="fas fa-user-plus" style="color: #4a7c59; font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <div><strong>Cadastro Simples</strong></div>
          <div style="font-size: 0.9rem; color: #666;">Apenas nome e email</div>
        </div>
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
          <i class="fas fa-envelope-circle-check" style="color: #4a7c59; font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <div><strong>Confirma√ß√£o Email</strong></div>
          <div style="font-size: 0.9rem; color: #666;">Verifica√ß√£o r√°pida</div>
        </div>
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
          <i class="fas fa-calendar-alt" style="color: #4a7c59; font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <div><strong>Acesso at√© 11/11</strong></div>
          <div style="font-size: 0.9rem; color: #666;">Totalmente gratuito</div>
        </div>
      </div>
      
      <a href="/escaladores/cadastro/" class="btn btn-success btn-lg" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 15px 40px; border-radius: 50px; font-weight: 600; text-decoration: none; display: inline-block; margin-top: 1rem;">
        <i class="fas fa-mountain"></i> Cadastrar como Escalador
      </a>
      
      <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
        <i class="fas fa-info-circle"></i> 
        J√° tem cadastro? <a href="/escaladores/reenviar-verificacao/" style="color: #4a7c59;">Reenvie a verifica√ß√£o</a>
      </p>
    </div>
  </div>
</section>

<!-- MODAL DE TRANSMISS√ÉO -->
    <div class="modal fade" id="streamingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #003366; color: white;">
            <h5 class="modal-title">üìπ Transmiss√£o ao Vivo - ClimaCocal</h5>
            <span id="countdown" class="badge bg-warning text-dark">3:00</span>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0; background: #000;">
            <!-- Container do v√≠deo sem controles nativos -->
            <div class="video-container" style="position: relative; background: #000;">
              <video id="cameraVideo" style="width: 100%; height: 400px; background: #000;" poster="{% static 'img/camera-loading.jpg' %}">
                <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando streaming...</span>
                  </div>
                </div>
              </video>
              
              <!-- Informa√ß√µes da c√¢mera - canto superior direito -->
              <div class="camera-info-overlay" style="position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 10;">
                <div style="display: flex; flex-direction: column; gap: 4px;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-clock" style="font-size: 11px; opacity: 0.8;"></i>
                    <span id="currentDateTime">--:--</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-thermometer-half" style="font-size: 11px; opacity: 0.8;"></i>
                    <span id="currentWeather">--¬∞C</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-map-marker-alt" style="font-size: 11px; opacity: 0.8;"></i>
                    <span style="opacity: 0.9;">Cocalzinho de Goi√°s</span>
                  </div>
                </div>
              </div>
              
              <!-- Controles customizados posicionados fora da √°rea do v√≠deo -->
              <div class="custom-video-controls" style="background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between;">
                <div class="controls-left" style="display: flex; align-items: center; gap: 15px;">
                  <button id="playPauseBtn" class="btn btn-sm btn-outline-light" style="border: none; background: transparent; font-size: 18px; padding: 4px 8px;">
                    <i class="fas fa-pause"></i>
                  </button>
                  <button id="muteBtn" class="btn btn-sm btn-outline-light" style="border: none; background: transparent; font-size: 16px; padding: 4px 8px;">
                    <i class="fas fa-volume-up"></i>
                  </button>
                  <span id="currentTime" style="font-size: 12px; color: #ccc;">00:00</span>
                </div>
                
                <div class="controls-center" style="flex: 1; margin: 0 15px;">
                  <div style="font-size: 12px; text-align: center; color: #ccc;">
                    <i class="fas fa-video me-1"></i>üì° Transmiss√£o ao vivo
                  </div>
                </div>
                
                <div class="controls-right" style="display: flex; align-items: center; gap: 10px;">
                  <button id="fullscreenBtn" class="btn btn-sm btn-outline-light" style="border: none; background: transparent; font-size: 16px; padding: 4px 8px;">
                    <i class="fas fa-expand"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <div id="streamStatus" class="text-center p-2" style="background: #f8f9fa;">
              <small class="text-muted">üîÑ Conectando √† c√¢mera...</small>
            </div>
            </div>
        </div>
        </div>
    </div>

  <!-- FOOTER -->
  <footer>
    <img src="{% static 'img/logo_rodape.png' %}" alt="Logo ClimaCocal Rodap√©" />
    <p>&copy; 2025 ClimaCocal. Todos os direitos reservados.</p>
  </footer>

  <script>
    // Bot√£o de menu toggle
    const menuToggle = document.getElementById("menuToggle");
    const menuDropdown = document.getElementById("menuDropdown");
    menuToggle?.addEventListener("click", () => {
      menuDropdown.style.display =
        menuDropdown.style.display === "block" ? "none" : "block";
    });

    // Vari√°veis globais
    let hls = null;
    let currentModal = null;
    let countdownTimer = null;

    // Fun√ß√£o para atualizar status do streaming
    function updateStreamStatus(message, isError = false) {
      const statusDiv = document.getElementById("streamStatus");
      if (statusDiv) {
        statusDiv.innerHTML = `<small class="${isError ? 'text-danger' : 'text-muted'}">${message}</small>`;
      }
    }

    // Fun√ß√£o para configurar o streaming HLS
    function setupHLSStreaming(videoElement, streamUrl) {
      updateStreamStatus("üîÑ Iniciando streaming...");
      
      if (Hls.isSupported()) {
        hls = new Hls({
          debug: false,
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 90
        });
        
        hls.loadSource(streamUrl);
        hls.attachMedia(videoElement);
        
        hls.on(Hls.Events.MEDIA_ATTACHED, () => {
          console.log("Video e HLS anexados");
          updateStreamStatus("üì° Conectado - Aguardando stream...");
        });
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          console.log("Playlist HLS carregada");
          updateStreamStatus("‚úÖ Streaming ativo");
          videoElement.play().catch(e => console.log("Auto-play bloqueado:", e));
        });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error("Erro HLS:", data);
          if (data.fatal) {
            updateStreamStatus("‚ùå Erro na conex√£o - Recarregue a p√°gina", true);
          }
        });
        
      } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari nativo
        videoElement.src = streamUrl;
        updateStreamStatus("‚úÖ Streaming ativo (Safari)");
      } else {
        updateStreamStatus("‚ùå Browser n√£o suporta HLS", true);
      }
    }

    // Fun√ß√£o para iniciar streaming
    function startStreaming() {
      return fetch("/streaming/api/start/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({})
      }).then(response => response.json());
    }

    // Fun√ß√£o para verificar status da API
    function checkStreamingStatus() {
      return fetch("/streaming/api/status/")
        .then(response => response.json());
    }

    // Bot√£o "Assistir ao Evento"
    document.getElementById("watchStreamBtn").addEventListener("click", async function () {
      try {
        updateStreamStatus("üîç Verificando status...");
        
        // Verificar status inicial
        let data = await checkStreamingStatus();
        console.log("Status inicial:", data);
        
        // Verificar pagamento
        if (data.payment_status !== "approved") {
          alert("‚ùå Pagamento ainda n√£o foi aprovado.\\n\\nPor favor, complete o pagamento primeiro.");
          return;
        }
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById("streamingModal"));
        currentModal = modal;
        modal.show();
        
        // Se streaming n√£o est√° ativo, tentar iniciar
        if (!data.access_granted || !data.stream_url) {
          updateStreamStatus("üöÄ Iniciando c√¢mera...");
          
          try {
            const startResult = await startStreaming();
            console.log("Resultado start:", startResult);
            
            if (startResult.success) {
              // Aguardar alguns segundos para playlist ser criada
              updateStreamStatus("‚è≥ Preparando streaming...");
              
              await new Promise(resolve => setTimeout(resolve, 5000));
              
              // Verificar status novamente
              data = await checkStreamingStatus();
              console.log("Status ap√≥s start:", data);
            } else {
              throw new Error(startResult.message || "Falha ao iniciar streaming");
            }
          } catch (error) {
            console.error("Erro ao iniciar streaming:", error);
            updateStreamStatus("‚ùå Erro ao iniciar c√¢mera", true);
            return;
          }
        }
        
        // Configurar streaming se dispon√≠vel
        if (data.access_granted && data.stream_url) {
          const videoElement = document.getElementById("cameraVideo");
          const correctStreamUrl = "/streaming/camera/stream.m3u8"; // URL correta
          
          setupHLSStreaming(videoElement, correctStreamUrl);
          startCountdown(modal);
        } else {
          updateStreamStatus("üì∑ C√¢mera temporariamente indispon√≠vel", true);
        }
        
      } catch (error) {
        console.error("Erro geral:", error);
        updateStreamStatus("‚ùå Erro de conex√£o - Tente novamente", true);
      }
    });

    // Countdown timer
    function startCountdown(modal) {
      let timeLeft = 180; // 3 minutos
      const countdownElem = document.getElementById("countdown");
      
      countdownTimer = setInterval(() => {
        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        countdownElem.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        if (timeLeft-- <= 0) {
          clearInterval(countdownTimer);
          cleanupStreaming();
          modal.hide();
        }
      }, 1000);
    }

    // Cleanup ao fechar modal
    function cleanupStreaming() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      const videoElement = document.getElementById("cameraVideo");
      if (videoElement) {
        videoElement.src = "";
        videoElement.load();
      }
    }

    // Event listener para cleanup quando modal √© fechado
    document.getElementById("streamingModal").addEventListener("hidden.bs.modal", cleanupStreaming);

    // ========================================
    // CONTROLES CUSTOMIZADOS DO V√çDEO
    // ========================================
    
    // Vari√°veis dos controles
    let isPlaying = false;
    let isMuted = false;
    let isFullscreen = false;

    // Configurar controles customizados
    function setupCustomControls() {
      const video = document.getElementById("cameraVideo");
      const playPauseBtn = document.getElementById("playPauseBtn");
      const muteBtn = document.getElementById("muteBtn");
      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const currentTimeDisplay = document.getElementById("currentTime");

      if (!video || !playPauseBtn || !muteBtn || !fullscreenBtn) return;

      // Play/Pause
      playPauseBtn.addEventListener("click", () => {
        if (video.paused) {
          video.play().then(() => {
            isPlaying = true;
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          }).catch(e => console.log("Erro ao reproduzir:", e));
        } else {
          video.pause();
          isPlaying = false;
          playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
      });

      // Mute/Unmute
      muteBtn.addEventListener("click", () => {
        video.muted = !video.muted;
        isMuted = video.muted;
        muteBtn.innerHTML = isMuted ? 
          '<i class="fas fa-volume-mute"></i>' : 
          '<i class="fas fa-volume-up"></i>';
      });

      // Fullscreen
      fullscreenBtn.addEventListener("click", () => {
        if (!document.fullscreenElement) {
          const videoContainer = document.querySelector(".video-container");
          if (videoContainer.requestFullscreen) {
            videoContainer.requestFullscreen();
          } else if (videoContainer.webkitRequestFullscreen) {
            videoContainer.webkitRequestFullscreen();
          } else if (videoContainer.msRequestFullscreen) {
            videoContainer.msRequestFullscreen();
          }
          isFullscreen = true;
          fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
          isFullscreen = false;
          fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
      });

      // Atualizar tempo (para streams ao vivo mostra dura√ß√£o)
      video.addEventListener("timeupdate", () => {
        if (video.duration && isFinite(video.duration)) {
          const current = video.currentTime;
          const duration = video.duration;
          const currentMinutes = Math.floor(current / 60);
          const currentSeconds = Math.floor(current % 60);
          const durationMinutes = Math.floor(duration / 60);
          const durationSeconds = Math.floor(duration % 60);
          
          currentTimeDisplay.textContent = 
            `${currentMinutes.toString().padStart(2, '0')}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes.toString().padStart(2, '0')}:${durationSeconds.toString().padStart(2, '0')}`;
        } else {
          // Para live streams
          currentTimeDisplay.textContent = "AO VIVO";
        }
      });

      // Auto-play quando stream carrega
      video.addEventListener("loadeddata", () => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
      });

      // Eventos de pause/play do v√≠deo
      video.addEventListener("play", () => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
      });

      video.addEventListener("pause", () => {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        isPlaying = false;
      });

      // Detectar sa√≠da do fullscreen
      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement) {
          fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
          isFullscreen = false;
        }
      });
    }

    // ========================================
    // ATUALIZA√á√ÉO DE INFORMA√á√ïES DA C√ÇMERA
    // ========================================
    
    // Fun√ß√£o para atualizar hora/data
    function updateDateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
      const dateString = now.toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: '2-digit' 
      });
      
      const dateTimeElement = document.getElementById("currentDateTime");
      if (dateTimeElement) {
        dateTimeElement.textContent = `${timeString} ${dateString}`;
      }
    }
    
    // Fun√ß√£o para buscar clima
    async function updateWeather() {
      try {
        const response = await fetch('/weather/');
        const data = await response.json();
        
        const weatherElement = document.getElementById("currentWeather");
        if (weatherElement && data.temperature) {
          weatherElement.textContent = `${Math.round(data.temperature)}¬∞C`;
        }
      } catch (error) {
        console.log("Erro ao buscar clima:", error);
        const weatherElement = document.getElementById("currentWeather");
        if (weatherElement) {
          weatherElement.textContent = "--¬∞C";
        }
      }
    }
    
    // Inicializar informa√ß√µes da c√¢mera
    let infoUpdateInterval = null;
    
    function startCameraInfoUpdates() {
      // Atualizar imediatamente
      updateDateTime();
      updateWeather();
      
      // Configurar atualiza√ß√µes peri√≥dicas
      infoUpdateInterval = setInterval(() => {
        updateDateTime();
        // Atualizar clima a cada 2 minutos
        if (new Date().getSeconds() === 0) {
          updateWeather();
        }
      }, 1000);
    }
    
    function stopCameraInfoUpdates() {
      if (infoUpdateInterval) {
        clearInterval(infoUpdateInterval);
        infoUpdateInterval = null;
      }
    }

    // Configurar controles quando modal abrir
    document.getElementById("streamingModal").addEventListener("shown.bs.modal", () => {
      setTimeout(setupCustomControls, 500);
      startCameraInfoUpdates();
    });
    
    // Parar atualiza√ß√µes quando modal fechar
    document.getElementById("streamingModal").addEventListener("hidden.bs.modal", () => {
      stopCameraInfoUpdates();
    });

  </script>
</body>
</html>
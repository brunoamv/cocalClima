<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pagamento - ClimaCocal</title>
  {% load static %}
  <!-- <script src="{% static 'js/script.js' %}"></script> -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}"> 
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- HLS.js para streaming -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body oncontextmenu="return false">
  <!-- HEADER PADRÃƒO -->
  <header class="site-header">
    <div class="header-container">
      <!-- Logo -->
      <img src="/static/img/logo_branca_header.png" alt="Logo ClimaCocal" class="logo" />

      <!-- Menu e Frase -->
      <div class="menu-area">
        <button id="menuToggle" class="menu-toggle" aria-label="Menu">
          <i class="fas fa-bars"></i> <span class="menu-label">Menu</span>
        </button>
        <div class="phrase-sucess">
              <h1 class="header-sucess">Como </h1>
              <h1 class="header-sucess">tÃ¡ o </h1> 
              <h1 class="header-sucess">tempo?</h1>
        </div>

        <nav class="menu-dropdown" id="menuDropdown">
          <ul>
            <li><a href="/">InÃ­cio</a></li>            
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- CONTEÃšDO -->
  <div class="container d-flex justify-content-center">
    <div class="col-lg-6 col-md-8 col-sm-10 payment-container mt-5 p-4" style="background-color: #fff3cd; border-radius: 12px; text-align: center; box-shadow: 0 0 25px rgba(0, 0, 0, 0.1);">
      {% if test_mode %}
      <div class="alert alert-warning mb-3">
        <i class="fas fa-flask me-2"></i><strong>MODO TESTE</strong> - {{ message }}
      </div>
      {% endif %}
      <h2 class="mb-4 text-success"><i class="fas fa-check-circle"></i> Pagamento Aprovado</h2>
      <p>Seu pagamento foi realizado com sucesso! VocÃª pode agora acessar a transmissÃ£o ao vivo.</p>
      <button id="watchStreamBtn" class="btn btn-primary hero-btn mb-2">
        <i class="fas fa-play-circle me-2"></i> Assistir ao Evento
      </button>
      <br />
      <a href="/" class="btn btn-secondary mt-2"><i class="fas fa-home me-1"></i> PÃ¡gina Inicial</a>
    </div>
  </div>
<!-- FECHA .container -->

<!-- MODAL DE TRANSMISSÃƒO -->
    <div class="modal fade" id="streamingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #003366; color: white;">
            <h5 class="modal-title">ðŸ“¹ TransmissÃ£o ao Vivo - ClimaCocal</h5>
            <span id="countdown" class="badge bg-warning text-dark">3:00</span>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0; background: #000;">
            <!-- Container do vÃ­deo sem controles nativos -->
            <div class="video-container" style="position: relative; background: #000;">
              <video id="cameraVideo" style="width: 100%; height: 400px; background: #000;" poster="/static/img/camera-loading.jpg">
                <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando streaming...</span>
                  </div>
                </div>
              </video>
              
              <!-- Controles customizados posicionados fora da Ã¡rea do vÃ­deo -->
              <div class="custom-video-controls" style="background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between;">
                <div class="controls-left" style="display: flex; align-items: center; gap: 15px;">
                  <button id="playPauseBtn" class="btn btn-sm btn-outline-light" style="border: none; background: transparent; font-size: 18px; padding: 4px 8px;">
                    <i class="fas fa-pause"></i>
                  </button>
                  <button id="muteBtn" class="btn btn-sm btn-outline-light" style="border: none; background: transparent; font-size: 16px; padding: 4px 8px;">
                    <i class="fas fa-volume-up"></i>
                  </button>
                  <span id="currentTime" style="font-size: 12px; color: #ccc;">00:00</span>
                </div>
                
                <div class="controls-center" style="flex: 1; margin: 0 15px;">
                  <div style="font-size: 12px; text-align: center; color: #ccc;">
                    <i class="fas fa-video me-1"></i>ðŸ“¡ TransmissÃ£o ao vivo
                  </div>
                </div>
                
                <div class="controls-right" style="display: flex; align-items: center; gap: 10px;">
                  <button id="fullscreenBtn" class="btn btn-sm btn-outline-light" style="border: none; background: transparent; font-size: 16px; padding: 4px 8px;">
                    <i class="fas fa-expand"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <div id="streamStatus" class="text-center p-2" style="background: #f8f9fa;">
              <small class="text-muted">ðŸ”„ Conectando Ã  cÃ¢mera...</small>
            </div>
            </div>
        </div>
        </div>
    </div>


<!-- FOOTER -->
  <footer>
    <img src="/static/img/logo_rodape.png" alt="Logo ClimaCocal RodapÃ©" />
    <p>&copy; 2025 ClimaCocal. Todos os direitos reservados.</p>
  </footer>

 



  <script>
    // BotÃ£o de menu toggle
    const menuToggle = document.getElementById("menuToggle");
    const menuDropdown = document.getElementById("menuDropdown");
    menuToggle?.addEventListener("click", () => {
      menuDropdown.style.display =
        menuDropdown.style.display === "block" ? "none" : "block";
    });

    // VariÃ¡veis globais
    let hls = null;
    let currentModal = null;
    let countdownTimer = null;

    // FunÃ§Ã£o para atualizar status do streaming
    function updateStreamStatus(message, isError = false) {
      const statusDiv = document.getElementById("streamStatus");
      if (statusDiv) {
        statusDiv.innerHTML = `<small class="${isError ? 'text-danger' : 'text-muted'}">${message}</small>`;
      }
    }

    // FunÃ§Ã£o para configurar o streaming HLS
    function setupHLSStreaming(videoElement, streamUrl) {
      updateStreamStatus("ðŸ”„ Iniciando streaming...");
      
      if (Hls.isSupported()) {
        hls = new Hls({
          debug: false,
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 90
        });
        
        hls.loadSource(streamUrl);
        hls.attachMedia(videoElement);
        
        hls.on(Hls.Events.MEDIA_ATTACHED, () => {
          console.log("Video e HLS anexados");
          updateStreamStatus("ðŸ“¡ Conectado - Aguardando stream...");
        });
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          console.log("Playlist HLS carregada");
          updateStreamStatus("âœ… Streaming ativo");
          videoElement.play().catch(e => console.log("Auto-play bloqueado:", e));
        });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error("Erro HLS:", data);
          if (data.fatal) {
            updateStreamStatus("âŒ Erro na conexÃ£o - Recarregue a pÃ¡gina", true);
          }
        });
        
      } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari nativo
        videoElement.src = streamUrl;
        updateStreamStatus("âœ… Streaming ativo (Safari)");
      } else {
        updateStreamStatus("âŒ Browser nÃ£o suporta HLS", true);
      }
    }

    // FunÃ§Ã£o para iniciar streaming
    function startStreaming() {
      return fetch("/streaming/api/start/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({})
      }).then(response => response.json());
    }

    // FunÃ§Ã£o para verificar status da API
    function checkStreamingStatus() {
      return fetch("/streaming/api/status/")
        .then(response => response.json());
    }

    // BotÃ£o "Assistir ao Evento"
    document.getElementById("watchStreamBtn").addEventListener("click", async function () {
      try {
        updateStreamStatus("ðŸ” Verificando status...");
        
        // Verificar status inicial
        let data = await checkStreamingStatus();
        console.log("Status inicial:", data);
        
        // Verificar pagamento
        if (data.payment_status !== "approved") {
          alert("âŒ Pagamento ainda nÃ£o foi aprovado.\n\nPor favor, complete o pagamento primeiro.");
          return;
        }
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById("streamingModal"));
        currentModal = modal;
        modal.show();
        
        // Se streaming nÃ£o estÃ¡ ativo, tentar iniciar
        if (!data.access_granted || !data.stream_url) {
          updateStreamStatus("ðŸš€ Iniciando cÃ¢mera...");
          
          try {
            const startResult = await startStreaming();
            console.log("Resultado start:", startResult);
            
            if (startResult.success) {
              // Aguardar alguns segundos para playlist ser criada
              updateStreamStatus("â³ Preparando streaming...");
              
              await new Promise(resolve => setTimeout(resolve, 5000));
              
              // Verificar status novamente
              data = await checkStreamingStatus();
              console.log("Status apÃ³s start:", data);
            } else {
              throw new Error(startResult.message || "Falha ao iniciar streaming");
            }
          } catch (error) {
            console.error("Erro ao iniciar streaming:", error);
            updateStreamStatus("âŒ Erro ao iniciar cÃ¢mera", true);
            return;
          }
        }
        
        // Configurar streaming se disponÃ­vel
        if (data.access_granted && data.stream_url) {
          const videoElement = document.getElementById("cameraVideo");
          const correctStreamUrl = "/streaming/camera/stream.m3u8"; // URL correta
          
          setupHLSStreaming(videoElement, correctStreamUrl);
          startCountdown(modal);
        } else {
          updateStreamStatus("ðŸ“· CÃ¢mera temporariamente indisponÃ­vel", true);
        }
        
      } catch (error) {
        console.error("Erro geral:", error);
        updateStreamStatus("âŒ Erro de conexÃ£o - Tente novamente", true);
      }
    });

    // Countdown timer
    function startCountdown(modal) {
      let timeLeft = 180; // 3 minutos
      const countdownElem = document.getElementById("countdown");
      
      countdownTimer = setInterval(() => {
        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        countdownElem.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        if (timeLeft-- <= 0) {
          clearInterval(countdownTimer);
          cleanupStreaming();
          modal.hide();
        }
      }, 1000);
    }

    // Cleanup ao fechar modal
    function cleanupStreaming() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      const videoElement = document.getElementById("cameraVideo");
      if (videoElement) {
        videoElement.src = "";
        videoElement.load();
      }
    }

    // Event listener para cleanup quando modal Ã© fechado
    document.getElementById("streamingModal").addEventListener("hidden.bs.modal", cleanupStreaming);

    // ========================================
    // CONTROLES CUSTOMIZADOS DO VÃDEO
    // ========================================
    
    // VariÃ¡veis dos controles
    let isPlaying = false;
    let isMuted = false;
    let isFullscreen = false;

    // Configurar controles customizados
    function setupCustomControls() {
      const video = document.getElementById("cameraVideo");
      const playPauseBtn = document.getElementById("playPauseBtn");
      const muteBtn = document.getElementById("muteBtn");
      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const currentTimeDisplay = document.getElementById("currentTime");

      if (!video || !playPauseBtn || !muteBtn || !fullscreenBtn) return;

      // Play/Pause
      playPauseBtn.addEventListener("click", () => {
        if (video.paused) {
          video.play().then(() => {
            isPlaying = true;
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          }).catch(e => console.log("Erro ao reproduzir:", e));
        } else {
          video.pause();
          isPlaying = false;
          playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
      });

      // Mute/Unmute
      muteBtn.addEventListener("click", () => {
        video.muted = !video.muted;
        isMuted = video.muted;
        muteBtn.innerHTML = isMuted ? 
          '<i class="fas fa-volume-mute"></i>' : 
          '<i class="fas fa-volume-up"></i>';
      });

      // Fullscreen
      fullscreenBtn.addEventListener("click", () => {
        if (!document.fullscreenElement) {
          const videoContainer = document.querySelector(".video-container");
          if (videoContainer.requestFullscreen) {
            videoContainer.requestFullscreen();
          } else if (videoContainer.webkitRequestFullscreen) {
            videoContainer.webkitRequestFullscreen();
          } else if (videoContainer.msRequestFullscreen) {
            videoContainer.msRequestFullscreen();
          }
          isFullscreen = true;
          fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
          isFullscreen = false;
          fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
      });

      // Atualizar tempo (para streams ao vivo mostra duraÃ§Ã£o)
      video.addEventListener("timeupdate", () => {
        if (video.duration && isFinite(video.duration)) {
          const current = video.currentTime;
          const duration = video.duration;
          const currentMinutes = Math.floor(current / 60);
          const currentSeconds = Math.floor(current % 60);
          const durationMinutes = Math.floor(duration / 60);
          const durationSeconds = Math.floor(duration % 60);
          
          currentTimeDisplay.textContent = 
            `${currentMinutes.toString().padStart(2, '0')}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes.toString().padStart(2, '0')}:${durationSeconds.toString().padStart(2, '0')}`;
        } else {
          // Para live streams
          currentTimeDisplay.textContent = "AO VIVO";
        }
      });

      // Auto-play quando stream carrega
      video.addEventListener("loadeddata", () => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
      });

      // Eventos de pause/play do vÃ­deo
      video.addEventListener("play", () => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
      });

      video.addEventListener("pause", () => {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        isPlaying = false;
      });

      // Detectar saÃ­da do fullscreen
      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement) {
          fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
          isFullscreen = false;
        }
      });
    }

    // Configurar controles quando modal abrir
    document.getElementById("streamingModal").addEventListener("shown.bs.modal", () => {
      setTimeout(setupCustomControls, 500);
    });

  </script>
</body>
</html>
